name: Sync Refund API to Postman

on:
  push:
    paths:
      - 'specs/payment-refund-api-openapi.yaml'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Update Spec in Postman
        run: |
          # Convert YAML to escaped string for JSON payload
          SPEC_CONTENT=$(sed 's/"/\\"/g' specs/payment-refund-api-openapi.yaml)

          curl -X PUT "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"spec\": {\"name\": \"Refund API\", \"content\": \"${SPEC_CONTENT}\", \"contentType\": \"yaml\"}}"

      - name: Regenerate Collection
        run: |
          curl -X POST "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}/generations/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"options": {"requestParametersResolution": "example"}}'

      - name: Install Postman CLI
        run: npm install -g postman-cli

      - name: Login using Postman API Key
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run Collection Tests
        run: |
          postman collection run 49129178-b921efd6-4b20-4f46-bb5c-ec04b16df293

