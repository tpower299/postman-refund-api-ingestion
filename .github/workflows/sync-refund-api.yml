name: Sync API Specs and Run Tests

on:
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.json'

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repo
      - uses: actions/checkout@v3

      # 2. Update API spec in Postman
      - name: Update API Spec in Postman
        run: |
          echo "Updating Postman API spec..."
          curl -s -X PUT "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @specs/payment-refund-api-openapi.yaml

      # 3. Regenerate collection from spec
      - name: Regenerate Collection
        run: |
          echo "Regenerating collection from spec..."
          curl -s -X POST "https://api.getpostman.com/specs/${{ secrets.POSTMAN_SPEC_ID }}/generations/collection" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"options": {"requestParametersResolution": "example"}}'

      # 4. Run collection tests against mock server
      - name: Run Collection Tests
        run: |
          echo "Running collection tests with mock server..."
          COLLECTION_ID="${{ secrets.POSTMAN_COLLECTION_ID }}"
          BASE_URL="${{ secrets.BASE_URL }}"

          curl -s -X POST "https://api.getpostman.com/collections/$COLLECTION_ID/run" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"environment\": {
                    \"values\": [
                      {\"key\": \"baseUrl\", \"value\": \"$BASE_URL\", \"enabled\": true}
                    ]
                  }
                }"

